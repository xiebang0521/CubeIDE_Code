#include "RFID.h"

uint8_t Config_ICType[6] = {0x06, 0x01, 0x42, 0x41, 0xfb, 0x03};
uint8_t Config_AutoReadID[6] = {0x06, 0x01, 0x45, 0x00, 0xbd, 0x03};
uint8_t Config_FilterCopyCard[6] = {0x06, 0x01, 0x46, 0x01, 0xbf, 0x03};
uint8_t Config_SectionPassward[14] = {0x0E, 0x01, 0x47, 0x01, 0x01, 0x60, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0XD7, 0x03};
uint8_t Config_ModuleAddr[6] = {0x06, 0x01, 0x48, 0x01, 0xb1, 0x03};
uint8_t Config_ChannelNum[6] = {0x06, 0x01, 0x50, 0x02, 0xaa, 0x03};
uint8_t Rc523_Respond[6];

/**
 * 获取校验码的值
 */
uint8_t Get_Bcc_Value(uint8_t* arr, uint8_t size) {
    uint8_t result = arr[0];

    for (int i = 1; i < size; i++) {
        result ^= arr[i];
    }

    // 异或取反
    result = ~result;

    return result;
}


void USART_SendArray(uint8_t* array,uint8_t size)
{
	HAL_USART_Transmit(&husart1, array, size, 100);
}

void USART_ReceiveArray(uint8_t* array, uint8_t size)
{
	uint8_t count = 0;
    while(count < size)
    {
        while(!__HAL_UART_GET_FLAG(&husart1, UART_FLAG_RXNE));
        HAL_USART_Receive(&husart1,array+count, 1, 100);
        count++;
    }
}

uint8_t RFID_Rc523_Config(void)
{
    uint8_t Config_State = 0;

    USART_SendArray(Config_ICType,6);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    USART_SendArray(Config_AutoReadID,6);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    USART_SendArray(Config_FilterCopyCard,6);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    USART_SendArray(Config_SectionPassward,14);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    USART_SendArray(Config_ModuleAddr,6);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    USART_SendArray(Config_ChannelNum,6);
    USART_ReceiveArray(Rc523_Respond,6);
    Config_State |= Config_State[3];

    return Config_State;
}
